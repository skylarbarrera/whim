services:
  # Docker Socket Proxy - secure access to Docker API
  # Only exposes specific endpoints needed for worker management
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: whim-docker-proxy
    restart: unless-stopped
    privileged: true
    environment:
      # Deny all by default, only allow what we need
      CONTAINERS: 1    # List, inspect, create, start, stop, kill, remove
      IMAGES: 1        # List images (needed to verify worker image exists)
      POST: 1          # Allow POST requests (create/start containers)
      # Everything else denied by default:
      # AUTH, BUILD, COMMIT, CONFIGS, DISTRIBUTION, EVENTS, EXEC,
      # GRPC, INFO, NETWORKS, NODES, PING, PLUGINS, SECRETS,
      # SERVICES, SESSION, SWARM, SYSTEM, TASKS, VERSION, VOLUMES
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - default
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:2375/_ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # PostgreSQL with pgvector extension for vector similarity search
  postgres:
    image: pgvector/pgvector:pg16
    container_name: whim-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-whim}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required in .env}
      POSTGRES_DB: ${POSTGRES_DB:-whim}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whim -d whim"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for rate limiting and distributed state
  redis:
    image: redis:7-alpine
    container_name: whim-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6380}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Orchestrator - manages work queue, workers, and coordination
  orchestrator:
    build:
      context: ..
      dockerfile: packages/orchestrator/Dockerfile
    container_name: whim-orchestrator
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      docker-proxy:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-whim}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/${POSTGRES_DB:-whim}
      REDIS_URL: redis://redis:6379
      # Connect to Docker via socket proxy (not direct socket)
      DOCKER_HOST: tcp://docker-proxy:2375
      MAX_WORKERS: ${MAX_WORKERS:-2}
      DAILY_BUDGET: ${DAILY_BUDGET:-200}
      COOLDOWN_SECONDS: ${COOLDOWN_SECONDS:-60}
      STALE_THRESHOLD: ${STALE_THRESHOLD:-300}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # AI harness selection (claude or codex)
      HARNESS: ${HARNESS:-claude}
      # Mock mode for testing lifecycle without Claude tokens
      MOCK_RALPH: ${MOCK_RALPH:-}
      MOCK_FAIL: ${MOCK_FAIL:-}
      MOCK_STUCK: ${MOCK_STUCK:-}
      PORT: 3000
    ports:
      - "${ORCHESTRATOR_PORT:-3002}:3000"
    # No direct Docker socket mount - uses docker-proxy instead
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Intake - polls GitHub for issues and generates specs
  intake:
    build:
      context: ..
      dockerfile: packages/intake/Dockerfile
    container_name: whim-intake
    restart: unless-stopped
    depends_on:
      orchestrator:
        condition: service_healthy
    environment:
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      REPOS: ${REPOS}
      ORCHESTRATOR_URL: http://whim-orchestrator:3000
      INTAKE_LABEL: ${INTAKE_LABEL:-ai-whim}
      POLL_INTERVAL: ${POLL_INTERVAL:-60000}
      ALLOWED_USERS: ${ALLOWED_USERS}

volumes:
  postgres_data:
    name: whim-postgres-data
  redis_data:
    name: whim-redis-data

networks:
  default:
    name: whim-network
