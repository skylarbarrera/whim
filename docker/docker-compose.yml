services:
  # PostgreSQL with pgvector extension for vector similarity search
  postgres:
    image: pgvector/pgvector:pg16
    container_name: whim-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: whim
      POSTGRES_PASSWORD: whim
      POSTGRES_DB: whim
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whim -d whim"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for rate limiting and distributed state
  redis:
    image: redis:7-alpine
    container_name: whim-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Orchestrator - manages work queue, workers, and coordination
  orchestrator:
    build:
      context: ..
      dockerfile: packages/orchestrator/Dockerfile
    container_name: whim-orchestrator
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://whim:whim@postgres:5432/whim
      REDIS_URL: redis://redis:6379
      MAX_WORKERS: ${MAX_WORKERS:-2}
      DAILY_BUDGET: ${DAILY_BUDGET:-200}
      COOLDOWN_SECONDS: ${COOLDOWN_SECONDS:-60}
      STALE_THRESHOLD: ${STALE_THRESHOLD:-300}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      # Mock mode for testing lifecycle without Claude tokens
      MOCK_RALPH: ${MOCK_RALPH:-}
      MOCK_FAIL: ${MOCK_FAIL:-}
      MOCK_STUCK: ${MOCK_STUCK:-}
      PORT: 3000
    ports:
      - "3002:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Intake - polls GitHub for issues and generates specs
  intake:
    build:
      context: ..
      dockerfile: packages/intake/Dockerfile
    container_name: whim-intake
    restart: unless-stopped
    depends_on:
      orchestrator:
        condition: service_healthy
    environment:
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      REPOS: ${REPOS}
      ORCHESTRATOR_URL: http://whim-orchestrator:3000
      INTAKE_LABEL: ${INTAKE_LABEL:-ai-whim}
      POLL_INTERVAL: ${POLL_INTERVAL:-60000}

  # Dashboard - web UI for monitoring (placeholder)
  dashboard:
    build:
      context: ..
      dockerfile: packages/dashboard/Dockerfile
    container_name: whim-dashboard
    restart: unless-stopped
    depends_on:
      orchestrator:
        condition: service_healthy
    environment:
      ORCHESTRATOR_URL: http://whim-orchestrator:3000
      PORT: 3001
    ports:
      - "3003:3001"
    profiles:
      - with-dashboard

volumes:
  postgres_data:
    name: whim-postgres-data
  redis_data:
    name: whim-redis-data

networks:
  default:
    name: whim-network
